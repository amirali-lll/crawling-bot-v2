# دستورالعمل‌های ساخت

## پیش‌نیازها

1. نصب PlatformIO Core یا PlatformIO IDE
   - **PlatformIO Core**: `pip install platformio`
   - **PlatformIO IDE**: افزونه "PlatformIO IDE" را در VS Code نصب کنید

## ساخت پروژه

### استفاده از PlatformIO Core (خط فرمان)

```bash
# به دایرکتوری پروژه بروید
cd crawling-bot-v2

# پروژه را بسازید
pio run

# روی ESP32-S3 آپلود کنید
pio run --target upload

# خروجی سریال را مانیتور کنید
pio device monitor -b 115200

# ساخت، آپلود و مانیتور در یک دستور
pio run --target upload && pio device monitor -b 115200
```

### استفاده از PlatformIO IDE (VS Code)

1. پوشه پروژه را در VS Code باز کنید
2. PlatformIO به طور خودکار پروژه را تشخیص می‌دهد
3. از نوار ابزار PlatformIO در پایین استفاده کنید:
   - روی "Build" (✓) کلیک کنید تا کامپایل شود
   - روی "Upload" (→) کلیک کنید تا روی برد فلش شود
   - روی "Serial Monitor" کلیک کنید تا خروجی را ببینید

## راه‌اندازی اولیه

در اولین بوت، ربات از طریق Serial Monitor شماره ربات (۱-۸) را درخواست می‌کند:

1. به Serial Monitor با سرعت 115200 baud متصل شوید
2. عددی بین ۱ تا ۸ وارد کنید
3. شماره در EEPROM ذخیره می‌شود
4. ربات AP با SSID ایجاد می‌کند: `ESP32-AP-{number}`
5. نام میزبان OTA خواهد بود: `ESP32-OTA-{number}`

## اتصالات سخت‌افزاری

### دستگاه‌های I2C (SDA/SCL - پین‌های پیش‌فرض ESP32)

- نمایشگر OLED (SSD1306) - آدرس: 0x3C
- سنسور AHRS MPU9250 - آدرس: 0x68

### سروها

- Servo Down - GPIO 32
- Servo Up - GPIO 33

### برق

- ESP32-S3 از طریق USB-C یا منبع تغذیه خارجی ۵ ولت
- سروها باید منبع تغذیه مناسب داشته باشند

## عیب‌یابی

### مشکلات ساخت

1. **پلتفرم پیدا نشد**: `pio pkg install` را اجرا کنید تا پلتفرم ESP32 دانلود شود
2. **خطاهای کتابخانه**: وابستگی‌ها به طور خودکار از platformio.ini نصب می‌شوند
3. **خطاهای کامپایل**: مطمئن شوید آخرین نسخه PlatformIO را دارید

### مشکلات زمان اجرا

1. **OLED تشخیص داده نشد**: اتصالات I2C و آدرس (0x3C) را بررسی کنید
2. **MPU9250 پیدا نشد**: آدرس I2C (0x68) و اتصالات را تأیید کنید
3. **سروها حرکت نمی‌کنند**: منبع تغذیه و پین‌های GPIO را بررسی کنید
4. **OTA کار نمی‌کند**: مطمئن شوید به AP ربات متصل هستید

## گردش کار توسعه

1. تغییرات کد را اعمال کنید
2. بسازید: `pio run`
3. خطاهای کامپایل را رفع کنید
4. آپلود کنید: `pio run --target upload`
5. خروجی سریال را مانیتور کنید: `pio device monitor -b 115200`
6. عملکرد را تست کنید
7. برای به‌روزرسانی‌های بعدی، در صورت امکان از OTA استفاده کنید

## به‌روزرسانی‌های OTA (پس از آپلود اولیه)

1. به WiFi AP ربات متصل شوید: `ESP32-AP-{robot_number}`
2. رمز عبور: `12345678`
3. از طریق OTA آپلود کنید:
   ```bash
   pio run --target upload --upload-port ESP32-OTA-{robot_number}.local
   ```

## کالیبراسیون

برای بهترین عملکرد AHRS، MPU9250 را کالیبره کنید:

1. main.cpp را تغییر دهید تا فراخوانی‌های کالیبراسیون را در setup() اضافه کنید:
   ```cpp
   ahrs.calibrateAccelGyro();  // سنسور را ثابت نگه دارید
   ahrs.calibrateMag();         // به شکل ۸ تکان دهید
   ```
2. آپلود کنید و دستورالعمل‌های سریال را دنبال کنید
3. پس از تکمیل، فراخوانی‌های کالیبراسیون را حذف کنید

## تست

بررسی سلامت به طور خودکار در زمان راه‌اندازی اجرا می‌شود و این موارد را تست می‌کند:

- نمایشگر OLED
- سنسور AHRS (جهت‌گیری)
- موتورهای سروو (حرکت)

نمایشگر OLED و خروجی سریال را برای وضعیت مانیتور کنید.

## نکات بهینه‌سازی

### بهبود عملکرد

- فرکانس به‌روزرسانی سنسور را تنظیم کنید
- سرعت حرکت سروها را بهینه کنید
- از FreeRTOS برای وظایف موازی استفاده کنید

### مدیریت حافظه

- از حافظه heap به طور محتاطانه استفاده کنید
- از متغیرهای استاتیک برای داده‌های بزرگ استفاده کنید
- نشتی حافظه را با مانیتور کردن heap آزاد بررسی کنید

### مصرف برق

- WiFi را در صورت عدم نیاز غیرفعال کنید
- از حالت‌های خواب عمیق استفاده کنید
- سرعت ساعت CPU را برای کارهای ساده کاهش دهید

## توسعه پیشرفته

### اشکال‌زدایی

```bash
# فعال کردن خروجی اشکال‌زدایی
pio run --target upload --environment debug

# استفاده از GDB
pio debug
```

### تست واحد

```bash
# اجرای تست‌های واحد
pio test
```

### تحلیل کد

```bash
# بررسی استفاده از حافظه
pio run --target size

# تحلیل استاتیک کد
pio check
```

## منابع مفید

- [مستندات PlatformIO](https://docs.platformio.org/)
- [راهنمای ESP32](https://docs.espressif.com/projects/esp-idf/)
- [EXAMPLES.fa.md](EXAMPLES.fa.md) - نمونه کدهای بیشتر
- [PROJECT_SUMMARY.fa.md](PROJECT_SUMMARY.fa.md) - اطلاعات فنی کامل
